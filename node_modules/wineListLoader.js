var q = require('q');
var fs = require("fs");
var path = require('path');
var xlsParser = require('xlsParser');

function listDirectory(root) {
    var deferred = q.defer();
    fs.readdir(root, function (err, files) {
        if (err) {
            deferred.reject(err);
        }
        else
        {
            var filtered = files
                .filter(function(file) { return path.extname(file).toLowerCase() === '.xls'; })
                .map(function(file){return path.join(root, file)});
            deferred.resolve(filtered);
        }
    });
    return deferred.promise;
}

function listWinesFromDir(root)
    {
        var d = q.defer();
        var files = listDirectory(root);
        files.then(function(files){
            var listings = [];
            files.forEach(function(file) {
                console.log('parsing: '+file);
                var deferred = q.defer();
                xlsParser.parseXlsFile(file)
                    .then(function(data) {
                        console.log('done: ' + file + ' ... ' + data.length.toString() + ' wines in file');
                        deferred.resolve(data)})
                    .catch(function(err){deferred.resolve([])});
                listings.push(deferred.promise);
            });
            q.allSettled(listings)
                .then(function(objs) {
                    var result = [];
                    objs.forEach(function(obj){result = [].concat(result, obj.value)});
                    console.log('total: ' + result.length);
                    d.resolve(result)})
                .catch(d.reject);
        });
       
        return d.promise;
    }


module.exports = {
    listDirectory: listDirectory,
    listWinesFromDir: listWinesFromDir
};