'use strict';
var q = require('q');
var libxmljs = require('xml2js');
var http = require('http');
var aresUrl = 'http://wwwinfo.mfcr.cz/cgi-bin/ares/darv_std.cgi?ico='


function getXml(ico) {
    var deferred = q.defer();
    var data = '';
    var req = http.get(aresUrl + ico.toString(), function(res) {
        var xml = '';
        res.on('data', function(chunk) {
            xml += chunk;
        });
        res.on('end', function() {
            var parseString = require('xml2js').parseString;
            parseString(xml, function (err, result) {
                if (err) {
                    deferred.reject(err);
                } else {
                    try {
                        var addr = result['are:Ares_odpovedi']['are:Odpoved'][0]['are:Zaznam'][0]['are:Identifikace'][0]['are:Adresa_ARES'][0];
                        var out = {
                            street: addr['dtt:Nazev_ulice'],
                            number: addr['dtt:Cislo_domovni'],
                            city: addr['dtt:Nazev_obce'],
                            postCode: addr['dtt:PSC']
                        };
                        deferred.resolve(out);
                    }
                    catch(err) {deferred.reject(err);}

                }
            });

        });

        });
    req.on('error', function(err) {
        deferred.reject(err);
    });
    return deferred.promise;
}



module.exports = getXml;